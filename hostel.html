<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hostel Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family:Arial; background:#f1f5f9; }
header {
  background:#0f766e; color:#fff; padding:15px;
  display:flex; justify-content:space-between; align-items:center;
}
header button {
  background:#fff; color:#0f766e; border:none;
  padding:8px 14px; border-radius:6px; font-weight:bold;
}
.container { padding:15px; }
.card {
  background:#fff; padding:15px; border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.1);
}
label { font-weight:bold; margin-top:12px; display:block; }
input,select {
  width:100%; padding:10px; margin-top:5px;
  border-radius:6px; border:1px solid #ccc;
}
.preview {
  width:100%; max-height:200px; margin-top:8px; border-radius:6px;
}
button.submit {
  width:100%; margin-top:20px; padding:12px;
  background:#0f766e; color:#fff; border:none;
  border-radius:8px; font-size:16px;
}
button.submit:disabled { background:#94a3b8; }
.info { margin-top:10px; color:#b91c1c; font-size:14px; }
</style>
</head>

<body>

<header>
  <h2>Hostel Management</h2>
  <button onclick="location.href='hostel_export.html'">Export</button>
</header>

<div class="container">
<div class="card">

<form id="form">

<label>Hostel Name</label>
<select id="hostelName" required>
  <option value="">Select Hostel</option>
  <option>Vigo</option><option>STPL</option><option>Champion</option>
  <option>Saddiq</option><option>Colony</option><option>Murree</option>
</select>

<label>Emp ID</label>
<input id="empId" required>
<div id="info" class="info"></div>

<label>Emp Name</label>
<input id="empName" required>

<label>Department</label>
<input id="department" required>

<label>Emergency Contact Name</label>
<input id="emergencyName" required>

<label>Relation With Employee</label>
<input id="emergencyRelation" required>

<label>Personal Mobile Number</label>
<input id="mobile" required>

<label>Permanent Address (CNIC)</label>
<input id="address" required>

<label>Hostel Joining Date</label>
<input type="date" id="joinDate" required>

<label>Hostel Leaving Date</label>
<input type="date" id="leaveDate">

<label>CNIC Picture</label>
<input type="file" id="cnicPic" accept="image/*" capture="environment" required>
<img id="cnicPreview" class="preview">

<label>Emp Card Picture</label>
<input type="file" id="empCardPic" accept="image/*" capture="environment" required>
<img id="empPreview" class="preview">

<button class="submit" id="submitBtn" disabled>Submit</button>

</form>
</div>
</div>

<script>
/* Login Permission */
const loggedInUser = localStorage.getItem("loggedInUser");
if (!loggedInUser) location.href="index.html";

/* GOOGLE APPS SCRIPT URL â€” REPLACE BELOW: */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMjMSDeI5HBNPBNQMQrW-RGNjkfMWH5QyAOx-YvDUC8M5NPum3V7tgipZi2RXj1pqc/exec";
// If you want to use the library link format, paste it here.
// Example: "https://script.google.com/macros/library/d/1pBu_boc9mBd3MVsd5KiGNVF9smTGOV2wgBa3Qf1woPkWRDtYl0vXNbXX/1"

const form = document.getElementById("form");
const submitBtn = document.getElementById("submitBtn");
const info = document.getElementById("info");

// Enable submit only when required fields are filled
form.addEventListener("input", () => {
  submitBtn.disabled = !(
    hostelName.value &&
    empId.value &&
    empName.value &&
    department.value &&
    emergencyName.value &&
    emergencyRelation.value &&
    mobile.value &&
    address.value &&
    joinDate.value &&
    cnicPic.files.length &&
    empCardPic.files.length
  );
});

// Preview camera images
cnicPic.onchange = () => { cnicPreview.src = URL.createObjectURL(cnicPic.files[0]); };
empCardPic.onchange = () => { empPreview.src = URL.createObjectURL(empCardPic.files[0]); };

// Convert image file to Base64 for script
function toBase64(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject("Image conversion failed");
    reader.readAsDataURL(file);
  });
}

// Handle form submit
form.onsubmit = async e => {
  e.preventDefault();
  submitBtn.disabled = true;

  // Prepare data
  const data = {
    enteredBy: loggedInUser,
    hostelName: hostelName.value,
    empId: empId.value,
    empName: empName.value,
    department: department.value,
    emergencyName: emergencyName.value,
    emergencyRelation: emergencyRelation.value,
    mobile: mobile.value,
    address: address.value,
    joinDate: joinDate.value,
    leaveDate: leaveDate.value || "",
    time: new Date().toISOString(),
    cnicPic: await toBase64(cnicPic.files[0]),
    empCardPic: await toBase64(empCardPic.files[0])
  };

  // Send to Google Apps Script
  try {
    const response = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(data)
    });
    const r = await response.json();
    if (r.status === "success") {
      alert("Record saved to Google Drive & Sheet successfully!");
    } else {
      alert("Record saved locally, but Google sync reported an error.");
      console.error(r);
    }
  } catch (err) {
    alert("Network/Script error: saved locally but not to Drive.");
    console.error(err);
  }

  // Save in localStorage as backup
  let records = JSON.parse(localStorage.getItem("hostelRecords")) || [];
  records.push(data);
  localStorage.setItem("hostelRecords", JSON.stringify(records));

  // Reset form
  form.reset();
  submitBtn.disabled = true;
};
</script>

</body>
</html>
