<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hostel Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
header{
  background:#0f766e;color:#fff;padding:15px;
  display:flex;justify-content:space-between;align-items:center
}
header button{
  background:#fff;color:#0f766e;border:none;
  padding:8px 14px;border-radius:6px;font-weight:bold
}
.container{padding:15px}
.card{
  background:#fff;padding:15px;border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.1)
}
label{font-weight:bold;margin-top:12px;display:block}
input,select{
  width:100%;padding:10px;margin-top:5px;
  border-radius:6px;border:1px solid #ccc
}
.preview{
  width:100%;max-height:200px;margin-top:8px;border-radius:6px
}
button.submit{
  width:100%;margin-top:20px;padding:12px;
  background:#0f766e;color:#fff;border:none;
  border-radius:8px;font-size:16px
}
button.submit:disabled{background:#94a3b8}
.info{margin-top:10px;color:#b91c1c;font-size:14px}
</style>
</head>

<body>

<header>
  <h2>Hostel Management</h2>
  <button onclick="location.href='hostel_export.html'">Export</button>
</header>

<div class="container">
<div class="card">

<form id="form">

<label>Hostel Name</label>
<select id="hostelName" required>
  <option value="">Select Hostel</option>
  <option>Vigo</option>
  <option>STPL</option>
  <option>Champion</option>
  <option>Saddiq</option>
  <option>Colony</option>
  <option>Murree</option>
</select>

<label>Emp ID</label>
<input id="empId" required>
<div id="info" class="info"></div>

<label>Emp Name</label>
<input id="empName" required>

<label>Department</label>
<input id="department" required>

<label>Emergency Contact Name</label>
<input id="emergencyName" required>

<label>Relation With Employee</label>
<input id="emergencyRelation" required>

<label>Personal Mobile Number</label>
<input id="mobile" required>

<label>Permanent Address (CNIC)</label>
<input id="address" required>

<label>Hostel Joining Date</label>
<input type="date" id="joinDate" required>

<label>Hostel Leaving Date</label>
<input type="date" id="leaveDate">

<label>CNIC Picture</label>
<input type="file" id="cnicPic" accept="image/*" capture="environment">
<img id="cnicPreview" class="preview">

<label>Emp Card Picture</label>
<input type="file" id="empCardPic" accept="image/*" capture="environment">
<img id="empPreview" class="preview">

<button class="submit" id="submitBtn" disabled>Submit</button>

</form>
</div>
</div>

<script>
/* ===== LOGIN CHECK ===== */
const loggedInUser = localStorage.getItem("loggedInUser");
if(!loggedInUser){
  location.href="index.html";
}

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMjMSDeI5HBNPBNQMQrW-RGNjkfMWH5QyAOx-YvDUC8M5NPum3V7tgipZi2RXj1pqc/exec";

const form = document.getElementById("form");
const submitBtn = document.getElementById("submitBtn");
const info = document.getElementById("info");

let activeRecord = null;

/* ===== EMP ID CHECK ===== */
empId.addEventListener("keydown", async e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    checkEmpId();
  }
});

async function checkEmpId(){
  info.innerText = "Checking record...";
  const res = await fetch(`${SCRIPT_URL}?action=checkEmp&empId=${empId.value}`);
  const data = await res.json();

  if(data.status==="active"){
    activeRecord = data.record;

    hostelName.value = data.record.hostelName;
    empName.value = data.record.empName;
    department.value = data.record.department;
    emergencyName.value = data.record.emergencyName;
    emergencyRelation.value = data.record.emergencyRelation;
    mobile.value = data.record.mobile;
    address.value = data.record.address;
    joinDate.value = data.record.joinDate;

    cnicPreview.src = data.record.cnicPic;
    empPreview.src = data.record.empCardPic;

    cnicPic.required = false;
    empCardPic.required = false;

    info.innerText = "Active record found. Enter Leaving Date to update.";
    submitBtn.disabled = true;
  }else{
    activeRecord = null;
    info.innerText = "";
    cnicPic.required = true;
    empCardPic.required = true;
  }
}

/* ===== VALIDATION ===== */
form.addEventListener("input", ()=>{
  if(activeRecord){
    submitBtn.disabled = !leaveDate.value;
  }else{
    submitBtn.disabled = !(
      hostelName.value &&
      empId.value &&
      empName.value &&
      department.value &&
      emergencyName.value &&
      emergencyRelation.value &&
      mobile.value &&
      address.value &&
      joinDate.value &&
      cnicPic.files.length &&
      empCardPic.files.length
    );
  }
});

/* ===== IMAGE PREVIEW ===== */
cnicPic.onchange = ()=> cnicPreview.src = URL.createObjectURL(cnicPic.files[0]);
empCardPic.onchange = ()=> empPreview.src = URL.createObjectURL(empCardPic.files[0]);

/* ===== SUBMIT ===== */
form.onsubmit = async e=>{
  e.preventDefault();

  const payload = {
    action: activeRecord ? "updateLeave" : "newEntry",
    enteredBy: loggedInUser,
    hostelName: hostelName.value,
    empId: empId.value,
    empName: empName.value,
    department: department.value,
    emergencyName: emergencyName.value,
    emergencyRelation: emergencyRelation.value,
    mobile: mobile.value,
    address: address.value,
    joinDate: joinDate.value,
    leaveDate: leaveDate.value || "",
    cnicPic: cnicPreview.src || "",
    empCardPic: empPreview.src || ""
  };

  await fetch(SCRIPT_URL,{
    method:"POST",
    body: JSON.stringify(payload)
  });

  alert("Record saved successfully");
  form.reset();
  submitBtn.disabled = true;
  info.innerText = "";
  activeRecord = null;
};
</script>

</body>
</html>
